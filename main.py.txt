import telebot
from telebot import types

# ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
TOKEN = "7546538278:AAHoxiQ5KTXrKV588k5LgqIrmzXwcNQuyG4"
bot = telebot.TeleBot(TOKEN)

# Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ§Øª
user_states = {}
user_reports = {}

# Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
def send_welcome(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row("Ø§Ø¨Ø¯Ø£")
    markup.row("Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ØªØ­Ø±Ø´", "Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ØªÙ‡Ø¯ÙŠØ¯")
    markup.row("Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø¨ÙŠØ¹ Ù…Ø®Ø¯Ø±Ø§Øª", "Ø¥Ø¨Ù„Ø§Øº Ù…ØªÙ†ÙˆØ¹")
    markup.row("Ø¥Ù„ØºØ§Ø¡")
    welcome_text = (
        "Ø§Ù„Ø´Ø±Ø·Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø·Ù† ğŸ‡©ğŸ‡¿\n\n"
        "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨Ù„ÙŠØº Ø§Ù„Ø¢Ù…Ù†.\n"
        "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©:"
    )
    bot.send_message(message.chat.id, welcome_text, reply_markup=markup)

# Ø¹Ù†Ø¯ /start Ø£Ùˆ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£"
@bot.message_handler(commands=['start'])
def handle_start_command(message):
    send_welcome(message)

@bot.message_handler(func=lambda message: message.text == "Ø§Ø¨Ø¯Ø£")
def handle_start_button(message):
    send_welcome(message)

# Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº
@bot.message_handler(func=lambda message: message.text in [
    "Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ØªØ­Ø±Ø´", "Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ØªÙ‡Ø¯ÙŠØ¯", "Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø¨ÙŠØ¹ Ù…Ø®Ø¯Ø±Ø§Øª", "Ø¥Ø¨Ù„Ø§Øº Ù…ØªÙ†ÙˆØ¹"
])
def ask_for_details(message):
    chat_id = message.chat.id
    user_states[chat_id] = "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„"
    user_reports[chat_id] = {"Ù†ÙˆØ¹": message.text}
    bot.send_message(chat_id, "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ø¯Ù‚Ø© (Ù…Ø§ Ø­Ø¯Ø«ØŒ Ù…ØªÙ‰ØŒ Ø£ÙŠÙ†ØŒ ÙˆÙ…Ù†):")

# Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº
@bot.message_handler(func=lambda message: message.text == "Ø¥Ù„ØºØ§Ø¡")
def cancel_report(message):
    chat_id = message.chat.id
    user_states.pop(chat_id, None)
    user_reports.pop(chat_id, None)
    bot.send_message(chat_id, "âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­.")

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ
@bot.message_handler(content_types=['text'])
def handle_text(message):
    chat_id = message.chat.id
    state = user_states.get(chat_id)

    if state == "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„":
        user_reports[chat_id]["Ø§Ù„ØªÙØ§ØµÙŠÙ„"] = message.text
        user_states[chat_id] = "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡Ø§ØªÙ"
        bot.send_message(chat_id, "ğŸ“ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ùƒ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±:")

    elif state == "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡Ø§ØªÙ":
        phone = message.text.strip()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØµØ§Ø±Ù… Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        if (
            phone.startswith(("05", "06", "07")) and
            len(phone) == 10 and
            phone.isdigit()
        ):
            user_reports[chat_id]["Ø§Ù„Ù‡Ø§ØªÙ"] = phone
            user_states[chat_id] = "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹"

            markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
            button_geo = types.KeyboardButton("ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ", request_location=True)
            markup.add(button_geo)
            bot.send_message(chat_id, "ğŸ“ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡:", reply_markup=markup)
        else:
            bot.send_message(chat_id, "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 Ø£Ùˆ 06 Ø£Ùˆ 07 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù….")

    else:
        send_welcome(message)

# Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
@bot.message_handler(content_types=['location'])
def handle_location(message):
    chat_id = message.chat.id
    if chat_id in user_states and user_states[chat_id] == "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹":
        latitude = message.location.latitude
        longitude = message.location.longitude

        report = user_reports.pop(chat_id, {})
        user_states.pop(chat_id, None)

        # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨Ù„Ø§Øº ÙÙŠ Ù…Ù„Ù
        with open("reports.txt", "a", encoding="utf-8") as file:
            file.write(
                f"Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {chat_id}:\n"
                f"Ø§Ù„Ù†ÙˆØ¹: {report.get('Ù†ÙˆØ¹')}\n"
                f"Ø§Ù„ØªÙØ§ØµÙŠÙ„: {report.get('Ø§Ù„ØªÙØ§ØµÙŠÙ„')}\n"
                f"Ø§Ù„Ù‡Ø§ØªÙ: {report.get('Ø§Ù„Ù‡Ø§ØªÙ')}\n"
                f"Ø§Ù„Ù…ÙˆÙ‚Ø¹: {latitude}, {longitude}\n\n"
            )

        bot.send_message(chat_id, "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ù…Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº. Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†Ùƒ.")
    else:
        bot.send_message(chat_id, "âš ï¸ Ù„Ù… Ù†Ø·Ù„Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø¨Ù„Ø§Øº Ø£ÙˆÙ„Ø§Ù‹.")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.infinity_polling()

